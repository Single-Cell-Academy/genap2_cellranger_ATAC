<tool id="cellranger_atac" name="CellRanger ATAC" version="0.1.0" python_template_version="3.5">
    <description>performs processing of 10x single-cell ATAC-seq data.</description>
    <requirements>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        mkdir ./fastq_dir &&
        #for $i1 in $fastq_i1#  
            ln -s $i1 ./fastq_dir/$i1.element_identifier;
        #end for#

        #for $r1 in $fastq_r1#
            ln -s $r1 ./fastq_dir/$r1.element_identifier;
        #end for#

        #for $r2 in $fastq_r2#
            ln -s $r2 ./fastq_dir/$r2.element_identifier;
        #end for#

        #for $r3 in $fastq_r3#
            ln -s $r3 ./fastq_dir/$r3.element_identifier;
	#end for#
	    /cellranger/cellranger-atac count --id=test --reference=/references/refdata-cellranger-arc-GRCh38-2020-A-2.0.0/ --fastqs ./fastq_dir --sample=$sample_name --localcores=8 --localmem=80 --disable-ui
    ]]></command>
    <inputs>
        <param type="data" name="fastq_i1" label="Select the I1 fastq file (Dual index i7 read (optional)):"  format="fastq.gz" multiple="true"/> 
        <param type="data" name="fastq_r1" label="Select the read1 (R1) fastq file (BC):" format="fastq.gz" multiple="true"/>
		<param type="data" name="fastq_r2" label="Select the Dual index i5 read file (R2/I2):" format="fastq.gz" multiple="true"/>
        <param type="data" name="fastq_r3" label="Select the read (R3) fastq file (DNA):" format="fastq.gz" multiple="true"/> 
        <param type="text" name="sample_ID" value="cellranger_atac" label="What is the sample ID?" optional="false"/>
        <param type="text" name="sample_name" label="What is the sample name?" optional="false"/>        
    </inputs>
    <outputs>
	    <data name="singlecell.csv" label="Per-barcode fragment counts and metrics" format="csv" from_work_dir="test/outs/singlecell.csv" />
        <collection type="list" label="BAM files" name="">
            <data name="possorted_bam.bam" label="Position sorted BAM file" format="bam" from_work_dir="test/outs/possorted_bam.bam"/>
            <data name="possorted_bam.bai" label="Position sorted BAM index" format="bai" from_work_dir="test/outs/possorted_bam.bam.bai"/>
        </collection>
        <data name="summary.json" label="Summary of all data metrics" format="json" from_work_dir='test/outs/summary.json'/> 
	<data name="web_summary.html" label="HTML file summarizing data and analysis" format="html" from_work_dir="test/outs/web_summary.html" /> 
        <collection type="list" label="Filtered peak bc matrix" name="filtered_peak_bc_matrix">
            <data name="barcodes" label="CellRanger barcodes file" format="txt" from_work_dir='test/outs/filtered_peak_bc_matrix/barcodes.tsv'/>
            <data name="peaks" label="Bed file of all called peak locations" format="bed" from_work_dir='test/outs/filtered_peak_bc_matrix/peaks.bed'/>
        </collection>
	    <data name="Raw peak BC matrix (H5)" label="Raw peak barcode matrix in hdf5 format" format="h5" from_work_dir='test/outs/raw_peak_bc_matrix.h5'/>
        <data name="Filtered peak BC matrix (H5)" label="Filtered peak barcode matrix in hdf5 format" format="h5" from_work_dir='test/outs/filtered_peak_bc_matrix.h5'/>
        <collection type="list" label="Fragment files" name="fragments">
            <data name="fragments_file" label="Barcoded and aligned fragment file" format="bgzip" from_work_dir='test/outs/fragments.tsv.gz'/>
            <data name="fragments_index" label="Fragments file index (tbi)" format="text" from_work_dir='test/outs/fragments.tsv.gz.tbi'/>
        </collection>
        <data name="filtered_tf_bc_matrix.h5" label="Filtered tf barcode matrix in hdf5 format" format="h5" from_work_dir='test/outs/filtered_tf_bc_matrix.h5'/>
        <data name="Cloupe file" label="cloupe_file" format="data" from_work_dir='test/outs/cloupe.cloupe'/>
        <data name="summary.csv" label=" csv summarizing important metrics and values" format="csv" from_work_dir='test/outs/summary.csv'/>
        <data name="peak_annotation.tsv" label="Annotation of peaks with genes" format="tsv" from_work_dir='test/outs/peak_annotation.tsv'/>
        <data name="peak_motif_mapping.bed" label="Peak-motif associations" format="bed" from_work_dir='test/outs/peak_motif_mapping.bed'/>
		<data name="matrix" label="Filtered CellRanger BC matrix" format="mtx" from_work_dir='test/outs/filtered_peak_bc_matrix/matrix.mtx'/>
        <collection type="list" label="Raw peak bc matrix" name="raw_peak_bc_matrix">
		    <data name="barcodes" label="Raw CellRanger barcodes file" format="txt" from_work_dir='test/outs/raw_peak_bc_matrix/barcodes.tsv'/>
		    <data name="peaks" label="Raw CellRanger peaks" format="bed" from_work_dir='test/outs/raw_peak_bc_matrix/peaks.bed'/>
		    <data name="matrix" label="Raw CellRanger matrix" format="mtx" from_work_dir='test/outs/raw_peak_bc_matrix/matrix.mtx'/>
        </collection>
    </outputs>
    <help><![CDATA[
        What is CellRanger ATAC? 
        https://support.10xgenomics.com/single-cell-atac/software/pipelines/latest/what-is-cell-ranger-atac
        
        Naming convention of FASTQ files internally in Galaxy follows thes guidelines: https://support.10xgenomics.com/single-cell-atac/software/pipelines/latest/using/fastq-input#rightname

        To use this tool, we assume that cellranger-atac (v.2.0.0) is available to Galaxy on the system, via the command cellranger-atac. Unfortunately at this point, we cannot include Cellranger-ATAC as 
        part of this wrapper due to Licensing and distribution limitations. For more information on how to install CellRanger-ATAC on your system, please see : 
        https://support.10xgenomics.com/single-cell-atac/software/pipelines/latest/installation
    ]]></help>
    <citations>
        <citation type="bibtex">
@misc{renameTODO,
  author = 10x Genomics,
  year = 2021,
  title = CellRanger-ATAC,
  url = {https://support.10xgenomics.com/single-cell-atac/software/pipelines/latest/using/fastq-input#ATACIntro},
}</citation>
    </citations>
</tool>
