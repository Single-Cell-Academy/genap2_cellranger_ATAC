<tool id="cellranger_atac" name="CellRanger ATAC" version="0.1.0" python_template_version="3.5">
    <description>performs processing of 10x single-cell ATAC-seq data.</description>
    <requirements>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        mkdir ./fastq_dir &&
        #for $i1 in $fastq_i1#  
            ln -s $i1 ./fastq_dir/$i1.element_identifier;
        #end for#

        #for $r1 in $fastq_r1#
            ln -s $r1 ./fastq_dir/$r1.element_identifier;
        #end for#

        #for $r2 in $fastq_r2#
            ln -s $r2 ./fastq_dir/$r2.element_identifier;
        #end for#

        #for $r3 in $fastq_r3#
            ln -s $r3 ./fastq_dir/$r3.element_identifier;
	#end for#
	echo "test" > hello_world.txt &&
	/cellranger/cellranger-atac count --id=cellranger --reference=/references/refdata-cellranger-arc-GRCh38-2020-A-2.0.0/ --fastqs ./fastq_dir --sample=$sample_name --localcores=8 --localmem=80 --disable-ui
    ]]></command>
    <inputs>
        <param type="data" name="fastq_i1" label="Select the I1 fastq file (Dual index i7 read (optional)):"  format="fastq.gz" multiple="true"/> 
        <param type="data" name="fastq_r1" label="Select the read1 (R1) fastq file (BC):" format="fastq.gz" multiple="true"/>
		<param type="data" name="fastq_r2" label="Select the Dual index i5 read file (R2/I2):" format="fastq.gz" multiple="true"/>
        <param type="data" name="fastq_r3" label="Select the read (R3) fastq file (DNA):" format="fastq.gz" multiple="true"/> 
        <param type="text" name="sample_name" label="What is the sample name?" optional="false"/>        
    </inputs>
    <outputs>
	    <data name="web_summary.html" label="CellRanger web summary report" format="html" from_work_dir='cellranger/outs/web_summary.html'/> 
	    <data name="Cloupe file" label="cloupe_file" format="data" from_work_dir='cellranger/outs/cloupe.cloupe'/>
        <collection type="list" label="Filtered peak bc matrix" name="filtered_peak_bc_matrix">
		<data name="barcodes" label="CellRanger barcodes file" format="txt" from_work_dir='cellranger/outs/filtered_peak_bc_matrix/barcodes.tsv'/>
		<data name="peaks" label="CellRanger peaks" format="bed" from_work_dir='cellranger/outs/filtered_peak_bc_matrix/peaks.bed'/>
		<data name="matrix" label="CellRanger BC matrix" format="mtx" from_work_dir='cellranger/outs/filtered_peak_bc_matrix/matrix.mtx'/>
        </collection>
	<data name="Filtered peak BC matrix (H5)" label="filtered_peak_bc_matrix_h5" format="h5" from_work_dir='cellranger/outs/filtered_peak_bc_matrix.h5'/>
        <collection type="list" label="Raw peak bc matrix" name="raw_peak_bc_matrix">
		<data name="barcodes" label="Raw CellRanger barcodes file" format="txt" from_work_dir='cellranger/outs/raw_peak_bc_matrix/barcodes.tsv'/>
		<data name="peaks" label="Raw CellRanger peaks" format="bed" from_work_dir='cellranger/outs/raw_peak_bc_matrix/peaks.bed'/>
		<data name="matrix" label="Raw CellRanger matrix" format="mtx" from_work_dir='cellranger/outs/raw_peak_bc_matrix/matrix.mtx'/>
        </collection>
	<data name="Raw peak BC matrix (H5)" label="raw_peak_bc_matrix_h5" format="h5" from_work_dir='cellranger/outs/raw_peak_bc_matrix.h5'/>
        <collection type="list" label="" name="fragments">
		<data name="fragments_file" label="Fragments file" format="bgzip" from_work_dir='cellranger/outs/fragments.tsv.gz'/>
		<data name="fragments_index" label="Fragments file index (tbi)" format="text" from_work_dir='cellranger/outs/fragments.tsv.gz.tbi'/>
        </collection>
        <collection type="list" label="Additional CellRanger output files" name="additional_outfiles">
		<data name="peak_annotation.tsv" label="Peak annotation" format="tsv" from_work_dir='cellranger/outs/peak_annotation.tsv'/>
		<data name="peak_motif_mapping.bed" label="Peak motif mapping file" format="bed" from_work_dir='cellranger/outs/peak_motif_mapping.bed'/>
		<data name="peaks.bed" label="Peaks bed file" format="bed" from_work_dir='cellranger/outs/peaks.bed'/>
		<data name="singlecell.csv" label="SingleCell csv file" format="csv" from_work_dir='cellranger/outs/singlecell.csv'/>
		<data name="summary.csv" label="Summary file" format="csv" from_work_dir='cellranger/outs/summary.csv'/>
	</collection>
        <collection type="list" label="BAM files" name="">
            <data name="possorted_bam.bam" label="Possorted BAM file" format="bam" from_work_dir="cellranger/outs/possorted_bam.bam"/>
            <data name="possorted_bam.bai" label="BAM index file" format="bai" from_work_dir="cellranger/outs/possorted_bam.bam.bai"/>
        </collection>
    </outputs>
    <help><![CDATA[
        What is CellRanger ATAC? 
        https://support.10xgenomics.com/single-cell-atac/software/pipelines/latest/what-is-cell-ranger-atac
        
        Naming convention of FASTQ files internally in Galaxy follows thes guidelines: https://support.10xgenomics.com/single-cell-atac/software/pipelines/latest/using/fastq-input#rightname

        To use this tool, we assume that cellranger-atac (v.2.0.0) is available to Galaxy on the system, via the command cellranger-atac. Unfortunately at this point, we cannot include Cellranger-ATAC as 
        part of this wrapper due to Licensing and distribution limitations. For more information on how to install CellRanger-ATAC on your system, please see : 
        https://support.10xgenomics.com/single-cell-atac/software/pipelines/latest/installation
    ]]></help>
    <citations>
        <citation type="bibtex">
@misc{renameTODO,
  author = 10x Genomics,
  year = 2021,
  title = CellRanger-ATAC,
  url = {https://support.10xgenomics.com/single-cell-atac/software/pipelines/latest/using/fastq-input#ATACIntro},
}</citation>
    </citations>
</tool>
